<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Inteligente - Distribuidora</title>
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --danger: #c0392b; }
        body { font-family: sans-serif; display: grid; grid-template-columns: 1fr 350px; gap: 20px; padding: 20px; background: #f4f4f4; }
        .caixa-principal { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .resumo-venda { background: var(--primary); color: white; padding: 20px; border-radius: 8px; }
        input, button { padding: 10px; font-size: 1.1rem; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border-bottom: 1px solid #ddd; padding: 10px; text-align: left; }
        .total-destaque { font-size: 2rem; color: #f1c40f; font-weight: bold; }
        .btn-vender { width: 100%; background: var(--success); color: white; border: none; cursor: pointer; padding: 15px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="caixa-principal">
        <h2>üõí Novo Pedido</h2>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="inputProduto" placeholder="Nome da Bebida ou C√≥digo" style="flex: 2;">
            <input type="number" id="inputQtd" value="1" style="width: 80px;">
            <button onclick="adicionarItem()" style="background: var(--primary); color: white; border: none; cursor: pointer;">Adicionar</button>
        </div>

        <table id="tabelaItens">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Qtd</th>
                    <th>Pre√ßo Un.</th>
                    <th>Subtotal</th>
                    <th>A√ß√£o</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

   <div style="display: flex; gap: 20px;">
    <div style="flex: 1;">
        <h2>üõí Carrinho de Compras</h2>
        <table id="tabelaCarrinho">...</table>
        <div id="totalVenda">Total: R$ 0,00</div>
        <button onclick="finalizarVenda()">Finalizar (F2)</button>
    </div>

    <div style="flex: 1; background: #f9f9f9; padding: 15px; border-radius: 10px;">
        <h2>üì¶ Produtos em Estoque</h2>
        <input type="text" id="filtroCatalogo" placeholder="üîç Filtrar produto..." onkeyup="filtrarCatalogo()">
        <div style="max-height: 400px; overflow-y: auto;">
            <table>
    <thead>
        <tr><th>Cod</th><th>Produto</th><th>Pre√ßo</th><th>Add</th></tr>
    </thead>
    <tbody id="corpoCatalogo"></tbody> </table>

<table>
    <thead>
        <tr><th>Item</th><th>Qtd</th><th>Subtotal</th><th>A√ß√£o</th></tr>
    </thead>
    <tbody id="corpoCarrinho"></tbody> </table>

<h1 id="totalVenda">R$ 0,00</h1>

<div id="modalQtd" style="display:none;">
    <input type="number" id="inputQtd" value="1">
    <button onclick="confirmarAdicao()">Confirmar</button>
</div>




    <div class="resumo-venda">
    <h3>Resumo</h3>
    <p>Total da Venda:</p>
    <div class="total-destaque">R$ <span id="valorTotal">0,00</span></div>
    
    <br>
    <label>Forma de Pagamento:</label>
    <div class="metodos-pagamento">
        <button class="btn-pgto" onclick="setPagamento('Pix', this)">üì± Pix</button>
        <button class="btn-pgto" onclick="setPagamento('Dinheiro', this)">üíµ Dinheiro</button>
        <button class="btn-pgto" onclick="setPagamento('D√©bito', this)">üí≥ D√©bito</button>
        <button class="btn-pgto" onclick="setPagamento('Cr√©dito', this)">üí≥ Cr√©dito</button>
    </div>
    
    <input type="hidden" id="formaSelecionada" value="">

    <div id="secaoTroco" style="display: none; margin-top: 15px; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px;">
        <label>Valor Recebido:</label>
        <input type="number" id="valorRecebido" placeholder="0,00" oninput="calcularTroco()" style="width: 80%; color: black;">
        <p>Troco: <span id="trocoResultado" style="font-weight: bold; color: #f1c40f;">R$ 0,00</span></p>
    </div>

    <br>
    <button class="btn-vender" onclick="finalizarVenda()">FINALIZAR (F2)</button>
</div>

   
    <script>
        let carrinho = [];
        let produtoSelecionado = null;
        let formaPagamento = 'Dinheiro';

        // Carrega os produtos assim que abrir a p√°gina
async function carregarCatalogo() {
    const res = await fetch('/api/produtos');
    const produtos = await res.json();
    window.produtosDoBanco = produtos;    renderizarCatalogo(produtos);

let carrinho = [];
let produtoSelecionado = null;

// Resolve o Erro: formaPagamento is not defined
let formaPagamento = 'Dinheiro'; 

async function carregarCatalogo() {
    const res = await fetch('/api/produtos');
    const produtos = await res.json();
    window.produtosDoBanco = produtos;

    const tabela = document.getElementById('corpoCatalogo');
    if (!tabela) return; // Evita o erro de "null"

    tabela.innerHTML = produtos.map(p => `
        <tr>
            <td>${p.id}</td>
            <td>${p.nome}</td>
            <td>R$ ${p.preco.toFixed(2)}</td>
            <td><button onclick="abrirModal(${p.id})">‚ûï</button></td>
        </tr>
    `).join('');
}

function abrirModal(id) {
    produtoSelecionado = window.produtosDoBanco.find(p => p.id === id);
    document.getElementById('modalQtd').style.display = 'flex';
}

function confirmarAdicao() {
    const qtd = parseInt(document.getElementById('inputQtd').value);
    const item = {
        ...produtoSelecionado,
        quantidade: qtd,
        subtotal: produtoSelecionado.preco * qtd
    };
    
    carrinho.push(item);
    atualizarInterface();
    document.getElementById('modalQtd').style.display = 'none';
}

function atualizarInterface() {
    const corpo = document.getElementById('corpoCarrinho');
    const displayTotal = document.getElementById('totalVenda');
    
    if (!corpo || !displayTotal) return; // Mata o erro 347 e 337

    let total = 0;
    corpo.innerHTML = carrinho.map((item, index) => {
        total += item.subtotal;
        return `
            <tr>
                <td>${item.nome}</td>
                <td>${item.quantidade}</td>
                <td>R$ ${item.subtotal.toFixed(2)}</td>
                <td><button onclick="remover(${index})">üóëÔ∏è</button></td>
            </tr>
        `;
    }).join('');

    displayTotal.innerText = `R$ ${total.toFixed(2)}`;
}

window.onload = carregarCatalogo;
}


function renderizarCatalogo(lista) {
    const corpo = document.getElementById('corpoCatalogo');
    corpo.innerHTML = '';
    lista.forEach(p => {
        corpo.innerHTML += `
            <tr>
                <td><strong>${String(p.id).padStart(3, '0')}</strong></td>
                <td>${p.nome}</td>
                <td>R$ ${p.preco.toFixed(2)}</td>
                <td>
                    <button onclick="selecionarProduto(${p.id})">‚ûï Adicionar</button>
                </td>
            </tr>
        `;
    });
}

// Fun√ß√£o para quando clicar no bot√£o da tabela
let produtoSelecionadoNoMomento = null;

// Agora essa fun√ß√£o apenas abre a janelinha
function selecionarProduto(id) {
    const produto = window.produtosDoBanco.find(p => p.id === id);
    if (produto) {
        produtoSelecionadoNoMomento = produto;
        document.getElementById('nomeProdutoModal').innerText = produto.nome;
        document.getElementById('qtdManual').value = 1; // Reseta para 1
        document.getElementById('modalQtd').style.display = 'flex';
        
        // Foca no campo de quantidade automaticamente
        setTimeout(() => document.getElementById('qtdManual').select(), 100);
    }
}

// Essa fun√ß√£o √© chamada quando voc√™ d√° Enter ou clica em Confirmar
function confirmarQtd() {
    const qtd = parseInt(document.getElementById('qtdManual').value) || 1;
    const produto = produtoSelecionadoNoMomento;

    if (produto) {
        // Usa sua l√≥gica de promo√ß√£o que j√° criamos (2 por 10, etc)
        const precoAplicado = calcularPrecoPromocional(produto.nome, qtd, produto.preco);
        const subtotal = precoAplicado * qtd;

        carrinho.push({
            id: produto.id,
            nome: produto.nome + (precoAplicado < produto.preco ? " ‚≠ê" : ""),
            preco: precoAplicado,
            qtd: qtd,
            subtotal: subtotal
        });

        atualizarInterface();
        mostrarAvisoPromo(`${qtd}x ${produto.nome} no carrinho!`);
        
        // Fecha a janelinha
        document.getElementById('modalQtd').style.display = 'none';
        produtoSelecionadoNoMomento = null;
    }
}// Filtro r√°pido para n√£o ter que rolar a lista
function filtrarCatalogo() {
    const termo = document.getElementById('filtroCatalogo').value.toLowerCase();
    const filtrados = window.produtosDoBanco.filter(p => 
        p.nome.toLowerCase().includes(termo) || p.id.toString().includes(termo)
    );
    renderizarCatalogo(filtrados);
}

window.onload = carregarCatalogo;


function mostrarAvisoPromo(mensagem) {
    const alerta = document.createElement('div');
    alerta.className = 'alerta-promo';
    alerta.innerHTML = `üéâ PROMO√á√ÉO ATIVA: ${mensagem}`;
    document.body.appendChild(alerta);

    setTimeout(() => {
        alerta.style.opacity = '0';
        setTimeout(() => alerta.remove(), 500);
    }, 3000);
}

let produtosDoBanco = [];

// Carrega os produtos assim que a p√°gina abre
window.onload = async () => {
    const response = await fetch('http://localhost:3000/api/produtos');
    produtosDoBanco = await response.json();
    popularSugestoes();
};

function popularSugestoes() {
    const datalist = document.getElementById('listaProdutos');
    datalist.innerHTML = ''; // Limpa antes de carregar
    
    produtosDoBanco.forEach(p => {
        const option = document.createElement('option');
        option.value = p.nome;
        datalist.appendChild(option);
    });
}

function calcularPrecoPromocional(nome, qtd, precoOriginal) {
    const nomeMinusculo = nome.toLowerCase();

    // Promo√ß√£o Heineken: de 9.99 por 7.99 (independente da qtd)
    if (nomeMinusculo.includes("heineken")) {
        return 7.99;
    }

    // Promo√ß√£o 2 por 10.00 (sai 5.00 cada) para Antarctica, Brahma e Imp√©rio
    const marcasPromo = ["antarctica", "brahma", "imperio"];
    const ehCervejaPromo = marcasPromo.some(marca => nomeMinusculo.includes(marca));

    if (ehCervejaPromo && qtd >= 2) {
        return 5.00; // Pre√ßo unit√°rio na promo√ß√£o
    }

    return precoOriginal;
}

async function adicionarItem() {
    const busca = document.getElementById('inputProduto').value;
    const qtd = parseInt(document.getElementById('inputQtd').value) || 1;
    
    const produto = produtosDoBanco.find(p => p.nome.toLowerCase() === busca.toLowerCase());

    if (produto) {
        const precoAplicado = calcularPrecoPromocional(produto.nome, qtd, produto.preco);
        
        // --- NOVO: VERIFICA√á√ÉO PARA O AVISO ---
        if (precoAplicado < produto.preco) {
            mostrarAvisoPromo(`${produto.nome} saiu por R$ ${precoAplicado.toFixed(2)} cada!`);
        }

        const subtotal = precoAplicado * qtd;

        carrinho.push({ 
            id: produto.id, 
            nome: produto.nome + (precoAplicado < produto.preco ? " ‚≠ê" : ""), 
            preco: precoAplicado, 
            qtd, 
            subtotal 
        });
        
        atualizarInterface();
        document.getElementById('inputProduto').value = '';
        document.getElementById('inputProduto').focus();
    }
}
 {
        alert("Selecione um produto da lista!");
 }

        let carrinho = [];
        
        function selecionarProduto(id) {
    const produto = window.produtosDoBanco.find(p => p.id === id);
    if (!produto) return;

    window.produtoAtual = produto;

    document.getElementById('modalQtd').style.display = 'flex';
    document.getElementById('inputQtd').value = 1;
    document.getElementById('inputQtd').focus();
}

function adicionarAoCarrinho() {
    const qtd = parseInt(document.getElementById('inputQtd').value);
    if (qtd <= 0) return;

    const item = {
        ...window.produtoAtual,
        quantidade: qtd,
        subtotal: window.produtoAtual.preco * qtd
    };

    carrinho.push(item);
    atualizarTabelaCarrinho();
    fecharModal();
}

// 3. Fun√ß√£o para desenhar o carrinho na tela
function atualizarTabelaCarrinho() {
    const corpo = document.getElementById('corpoCarrinho');
    let totalGeral = 0;
    corpo.innerHTML = '';

    carrinho.forEach((item, index) => {
        totalGeral += item.subtotal;
        corpo.innerHTML += `
            <tr>
                <td>${item.nome}</td>
                <td>${item.quantidade}</td>
                <td>R$ ${item.subtotal.toFixed(2)}</td>
                <td><button onclick="removerDoCarrinho(${index})">üóëÔ∏è</button></td>
            </tr>
        `;
    });

    document.getElementById('totalVenda').innerText = `R$ ${totalGeral.toFixed(2)}`;
}

        // Simula√ß√£o de banco de dados local para teste r√°pido
        const buscarProduto = (nome) => {
            // Aqui depois faremos o fetch() para o backend
            return { nome: nome, preco: 5.50 }; 
        }
        
        function setPagamento(metodo, elemento) {
    formaPagamento = metodo;
    
    // Mostra se√ß√£o de troco apenas se for Dinheiro
    const secao = document.getElementById('secaoTroco');
    if (metodo === 'Dinheiro') {
        secao.style.display = 'block';
        document.getElementById('valorRecebido').focus();
    } else {
        secao.style.display = 'none';
    }

    // Estiliza√ß√£o dos bot√µes
    document.querySelectorAll('.btn-pgto').forEach(btn => btn.classList.remove('ativo'));
    elemento.classList.add('ativo');
}

function calcularTroco() {
    const recebido = parseFloat(document.getElementById('valorRecebido').value) || 0;
    const troco = recebido - total;
    const displayTroco = document.getElementById('trocoResultado');

    if (recebido > 0 && troco >= 0) {
        displayTroco.innerText = `R$ ${troco.toFixed(2)}`;
        displayTroco.style.color = "#27ae60"; // Verde se estiver ok
    } else {
        displayTroco.innerText = `R$ 0,00`;
        displayTroco.style.color = "#f1c40f";
    }
}
       async function adicionarItem() {
    const busca = document.getElementById('inputProduto').value;
    const qtd = parseInt(document.getElementById('inputQtd').value);
    
    // Busca no banco de dados
    const response = await fetch('http://localhost:3000/api/produtos');
    const produtos = await response.json();
    
    // Procura o produto pelo nome
    const produtoEncontrado = produtos.find(p => p.nome.toLowerCase().includes(busca.toLowerCase()));

    if (produtoEncontrado) {
        const subtotal = produtoEncontrado.preco * qtd;
        carrinho.push({ 
            id: produtoEncontrado.id, 
            nome: produtoEncontrado.nome, 
            preco: produtoEncontrado.preco, 
            qtd, 
            subtotal 
        });
        atualizarInterface();
        document.getElementById('inputProduto').value = '';
        document.getElementById('inputProduto').focus();
    } else {
        alert("Produto n√£o encontrado no estoque!");
    }
}

      function atualizarInterface() {
    const corpoCarrinho = document.getElementById('corpoCarrinho');
    corpoCarrinho.innerHTML = '';
    let totalGeral = 0;

    carrinho.forEach((item, index) => {
        totalGeral += item.subtotal;
        corpoCarrinho.innerHTML += `
            <tr>
                <td>${item.nome}</td>
                <td>${item.qtd}</td>
                <td>R$ ${item.preco.toFixed(2)}</td>
                <td>R$ ${item.subtotal.toFixed(2)}</td>
                <td>
                    <button onclick="removerItem(${index})" style="background:none; border:none; color:#e74c3c; cursor:pointer; font-size:18px;">
                        üóëÔ∏è
                    </button>
                </td>
            </tr>
        `;
    });

    document.getElementById('totalVenda').innerText = `Total: R$ ${totalGeral.toFixed(2)}`;
}
// Se mudar o total, recalcula o troco automaticamente
    if(formaPagamento === 'Dinheiro') calcularTroco();


function removerItem(index) {
    // Remove 1 item na posi√ß√£o 'index'
    carrinho.splice(index, 1);
    
    // Atualiza a tela para mostrar o carrinho novo
    atualizarInterface();
    
    // Opcional: Avisar que foi removido
    console.log("Item removido do carrinho.");
}
      function finalizarVenda() {
    if (carrinho.length === 0) return alert("Carrinho vazio!");
    if (!formaPagamento) return alert("Selecione o pagamento!");

    let recebido = 0;
    let troco = 0;

    if (formaPagamento === 'Dinheiro') {
        recebido = parseFloat(document.getElementById('valorRecebido').value) || 0;
        if (recebido < total) return alert("Valor insuficiente!");
        troco = recebido - total;
    }

    // --- GERANDO O TEXTO DO RECIBO ---
    const cabecalho = "==== √â A BOA DISTRIBUIDORA ====\n";
    const dataVenda = `Data: ${new Date().toLocaleString()}\n`;
    const divisor = "----------------------------------\n";
    let itensTexto = "PRODUTO           QTD    SUBTOTAL\n";

    carrinho.forEach(item => {
        // Formata√ß√£o simples para alinhar colunas
        const nomeCurto = item.nome.substring(0, 15).padEnd(16, " ");
        const qtdStr = item.qtd.toString().padEnd(6, " ");
        itensTexto += `${nomeCurto} ${qtdStr} R$ ${item.subtotal.toFixed(2)}\n`;
    });

    const rodape = `\nTOTAL: R$ ${total.toFixed(2)}\n` +
                   `PAGAMENTO: ${formaPagamento}\n` +
                   (formaPagamento === 'Dinheiro' ? `RECEBIDO: R$ ${recebido.toFixed(2)}\nTROCO: R$ ${troco.toFixed(2)}\n` : "") +
                   "\n==================================\n" +
                   "OBRIGADO PELA PREFERENCIA!";

    const cupomCompleto = cabecalho + dataVenda + divisor + itensTexto + divisor + rodape;

    // Exibe o recibo na tela (opcional)
    document.getElementById('textoRecibo').innerText = cupomCompleto;
    document.getElementById('areaRecibo').style.display = 'block';

    alert("Venda registrada!");

    // Dentro da fun√ß√£o finalizarVenda, logo ap√≥s o alert:
fetch('http://localhost:3000/api/vendas', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        total: total,
        pagamento: formaPagamento,
        itens: carrinho
    })
})
.then(res => res.json())
.then(dados => console.log("Salvo no banco:", dados))
.catch(err => console.error("Erro ao salvar:", err));
    
     
}

async function carregarCatalogo() {
    console.log("Tentando buscar produtos..."); // Isso vai aparecer no F12
    try {
        const res = await fetch('/api/produtos'); // Busca na rota que voc√™ testou
        if (!res.ok) throw new Error('Erro ao buscar dados do servidor');
        
        const produtos = await res.json();
        console.log("Produtos recebidos:", produtos);

        window.produtosDoBanco = produtos; // Guarda na mem√≥ria
        
        const corpo = document.getElementById('corpoCatalogo');
        if (!corpo) {
            console.error("Erro: N√£o achei a tabela com id 'corpoCatalogo'");
            return;
        }

        corpo.innerHTML = ''; // Limpa a tabela antes de encher
        
        produtos.forEach(p => {
            corpo.innerHTML += `
                <tr>
                    <td><strong>${String(p.id).padStart(3, '0')}</strong></td>
                    <td>${p.nome}</td>
                    <td>R$ ${p.preco.toFixed(2)}</td>
                    <td>
                        <button onclick="selecionarProduto(${p.id})" style="cursor:pointer; padding:5px 10px;">‚ûï</button>
                    </td>
                </tr>
            `;
        });
    } catch (erro) {
        console.error("Erro detalhado:", erro);
    }
}

// Isso garante que a fun√ß√£o rode assim que a p√°gina abrir
window.onload = carregarCatalogo;

function copiarRecibo() {
    const texto = document.getElementById('textoRecibo').innerText;
    navigator.clipboard.writeText(texto).then(() => {
        alert("Cupom copiado! Agora √© s√≥ colar no WhatsApp do cliente.");
    });
}
function resetarPDV() {
    carrinho = [];
    formaPagamento = "";
    total = 0;
    document.getElementById('valorRecebido').value = '';
    document.getElementById('secaoTroco').style.display = 'none';
    document.querySelectorAll('.btn-pgto').forEach(btn => btn.classList.remove('ativo'));
    atualizarInterface();
}
        

        // Atalho de teclado: F2 finaliza
        window.addEventListener('keydown', (e) => {
            if(e.key === 'F2') finalizarVenda();
        });
    </script>

    <div id="areaRecibo" style="display: none;">
    <pre id="textoRecibo" style="font-family: monospace; background: white; padding: 10px;"></pre>
    <button onclick="copiarRecibo()" style="background: #25d366; color: white; border: none; padding: 10px; width: 100%; cursor: pointer;">
        Copiado para WhatsApp üì±
    </button>
<div id="modalQtd" class="modal-qtd">
    <div class="modal-conteudo">
        <h3 id="nomeProdutoModal">Produto</h3>
        <p>Informe a quantidade:</p>
        <input type="number" id="qtdManual" value="1" min="1" onkeypress="if(event.key==='Enter') confirmarQtd()">
        <button class="btn-confirmar" onclick="confirmarQtd()">Confirmar (Enter)</button>
        <button onclick="document.getElementById('modalQtd').style.display='none'" style="margin-top:10px; border:none; background:none; color:gray; cursor:pointer;">Cancelar</button>
    </div>
</div>

</div>
</body>
</html>