<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Inteligente - Distribuidora</title>
    <style>
        :root { 
            --primary: #2c3e50; 
            --success: #27ae60; 
            --danger: #c0392b; 
            --warning: #f1c40f;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            display: grid; 
            grid-template-columns: 1fr 400px; 
            gap: 20px; 
            padding: 20px; 
            background: #ecf0f1; 
            margin: 0;
        }

        /* Layout */
        .col-esquerda { display: flex; flex-direction: column; gap: 20px; }
        .caixa-principal, .catalogo-container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }

        /* Tabelas */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8f9fa; color: var(--primary); text-align: left; padding: 12px; border-bottom: 2px solid #dee2e6; }
        td { padding: 12px; border-bottom: 1px solid #eee; }

        /* Inputs e Bot√µes */
        input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
        button { cursor: pointer; border-radius: 4px; transition: 0.2s; }
        
        .btn-pgto { 
            padding: 10px; border: 1px solid #ccc; background: white; 
            flex: 1; font-weight: bold;
        }
        .btn-pgto.ativo { background: var(--primary); color: white; border-color: var(--primary); }

        .resumo-venda { 
            background: var(--primary); 
            color: white; 
            padding: 25px; 
            border-radius: 8px; 
            position: sticky; 
            top: 20px;
        }

        .total-destaque { font-size: 2.5rem; color: var(--warning); font-weight: bold; margin: 10px 0; }
        .btn-vender { 
            width: 100%; background: var(--success); color: white; 
            border: none; padding: 18px; font-weight: bold; font-size: 1.2rem; margin-top: 15px;
        }

        /* Modal */
        .modal-qtd {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-conteudo { background: white; padding: 30px; border-radius: 10px; width: 300px; text-align: center; }
        .modal-conteudo input { width: 80%; text-align: center; font-size: 1.5rem; margin: 15px 0; }

        /* Promo√ß√£o Alerta */
        .alerta-promo {
            position: fixed; top: 20px; right: 20px; background: var(--success);
            color: white; padding: 15px 25px; border-radius: 5px; z-index: 2000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: 0.5s;
        }

        .metodos-pagamento { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        
        #areaRecibo { margin-top: 20px; border: 1px dashed #ccc; padding: 10px; background: #fff; color: #333; }
        pre { white-space: pre-wrap; font-size: 0.85rem; }
    </style>
</head>
<body>

    <div class="col-esquerda">
        <div class="caixa-principal">
            <h2>üõí Novo Pedido</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="text" id="inputProduto" placeholder="Nome da Bebida ou C√≥digo" style="flex: 2;" list="listaSugestoes">
                <datalist id="listaSugestoes"></datalist>
                <input type="number" id="inputQtdRapido" value="1" style="width: 80px;">
                <button onclick="adicionarManual()" style="background: var(--primary); color: white; border: none; padding: 0 20px;">Adicionar</button>
            </div>

            <h3>Itens do Carrinho</h3>
            <table>
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Qtd</th>
                        <th>Pre√ßo Un.</th>
                        <th>Subtotal</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="corpoCarrinho"></tbody>
            </table>
        </div>

        <div class="catalogo-container">
            <h2>üì¶ Cat√°logo de Produtos</h2>
            <input type="text" id="filtroCatalogo" placeholder="üîç Filtrar produto por nome ou c√≥digo..." onkeyup="filtrarCatalogo()" style="width: 95%; margin-bottom: 15px;">
            <div style="max-height: 400px; overflow-y: auto;">
                <table>
                    <thead>
                        <tr><th>Cod</th><th>Produto</th><th>Pre√ßo</th><th>Add</th></tr>
                    </thead>
                    <tbody id="corpoCatalogo"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="resumo-venda">
        <h3>Resumo da Venda</h3>
        <p>Total a Pagar:</p>
        <div class="total-destaque" id="valorTotal">R$ 0,00</div>
        
        <label>Forma de Pagamento:</label>
        <div class="metodos-pagamento">
            <button class="btn-pgto" onclick="setPagamento('Pix', this)">üì± Pix</button>
            <button class="btn-pgto" onclick="setPagamento('Dinheiro', this)">üíµ Dinheiro</button>
            <button class="btn-pgto" onclick="setPagamento('D√©bito', this)">üí≥ D√©bito</button>
            <button class="btn-pgto" onclick="setPagamento('Cr√©dito', this)">üí≥ Cr√©dito</button>
        </div>

        <div id="secaoTroco" style="display: none; margin-top: 20px; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 5px;">
            <label>Valor Recebido:</label>
            <input type="number" id="valorRecebido" placeholder="0,00" oninput="calcularTroco()" style="width: 100%; margin-top: 5px;">
            <p style="margin-top: 10px;">Troco: <span id="trocoResultado" style="font-weight: bold; color: var(--warning);">R$ 0,00</span></p>
        </div>

        <button class="btn-vender" onclick="finalizarVenda()">FINALIZAR (F2)</button>

        <div id="areaRecibo" style="display: none;">
            <pre id="textoRecibo"></pre>
            <button onclick="copiarRecibo()" style="background: #25d366; color: white; border: none; padding: 10px; width: 100%; cursor: pointer; border-radius: 4px;">
                Copiar p/ WhatsApp üì±
            </button>
        </div>
    </div>

    <!-- Modal de Quantidade -->
    <div id="modalQtd" class="modal-qtd">
        <div class="modal-conteudo">
            <h3 id="nomeProdutoModal">Produto</h3>
            <p>Informe a quantidade:</p>
            <input type="number" id="qtdManual" value="1" min="1">
            <button class="btn-vender" style="margin-top: 0;" onclick="confirmarQtd()">Confirmar (Enter)</button>
            <button onclick="fecharModal()" style="margin-top:10px; border:none; background:none; color:gray; cursor:pointer;">Cancelar</button>
        </div>
    </div>

    <script>
        // Configura√ß√µes e Estado Global
        let produtosDoBanco = [];
        let carrinho = [];
        let totalVenda = 0;
        let formaPagamento = '';
        let produtoSelecionadoNoMomento = null;
        const API_URL = 'http://localhost:3000/api'; // Ajuste conforme seu backend

        // Inicializa√ß√£o
        window.onload = async () => {
            await carregarProdutos();
            document.getElementById('inputProduto').focus();
        };

        // Atalhos de teclado
        window.addEventListener('keydown', (e) => {
            if(e.key === 'F2') finalizarVenda();
            if(e.key === 'Enter' && document.getElementById('modalQtd').style.display === 'flex') confirmarQtd();
        });

        async function carregarProdutos() {
            try {
                // Simula√ß√£o de dados caso o fetch falhe (para teste local)
                const mockData = [
                    {id: 1, nome: "Cerveja Heineken 330ml", preco: 9.99},
                    {id: 2, nome: "Cerveja Antarctica 269ml", preco: 6.50},
                    {id: 3, nome: "Cerveja Brahma 350ml", preco: 5.80},
                    {id: 4, nome: "Cerveja Imp√©rio 269ml", preco: 5.50},
                    {id: 5, nome: "Coca-Cola 2L", preco: 12.00}
                ];

                const res = await fetch(`${API_URL}/produtos`).catch(() => null);
                produtosDoBanco = res ? await res.json() : mockData;
                
                renderizarCatalogo(produtosDoBanco);
                popularSugestoes();
            } catch (err) {
                console.error("Erro ao carregar cat√°logo:", err);
            }
        }

        function popularSugestoes() {
            const list = document.getElementById('listaSugestoes');
            list.innerHTML = produtosDoBanco.map(p => `<option value="${p.nome}">`).join('');
        }

        function renderizarCatalogo(lista) {
            const corpo = document.getElementById('corpoCatalogo');
            corpo.innerHTML = lista.map(p => `
                <tr>
                    <td><strong>${String(p.id).padStart(3, '0')}</strong></td>
                    <td>${p.nome}</td>
                    <td>R$ ${p.preco.toFixed(2)}</td>
                    <td><button onclick="abrirModal(${p.id})">‚ûï</button></td>
                </tr>
            `).join('');
        }

        function filtrarCatalogo() {
            const termo = document.getElementById('filtroCatalogo').value.toLowerCase();
            const filtrados = produtosDoBanco.filter(p => 
                p.nome.toLowerCase().includes(termo) || p.id.toString().includes(termo)
            );
            renderizarCatalogo(filtrados);
        }

        // L√≥gica do Modal
        function abrirModal(id) {
            produtoSelecionadoNoMomento = produtosDoBanco.find(p => p.id === id);
            document.getElementById('nomeProdutoModal').innerText = produtoSelecionadoNoMomento.nome;
            document.getElementById('qtdManual').value = 1;
            document.getElementById('modalQtd').style.display = 'flex';
            setTimeout(() => document.getElementById('qtdManual').select(), 100);
        }

        function fecharModal() {
            document.getElementById('modalQtd').style.display = 'none';
            produtoSelecionadoNoMomento = null;
        }

        function confirmarQtd() {
            const qtd = parseInt(document.getElementById('qtdManual').value) || 1;
            adicionarAoCarrinho(produtoSelecionadoNoMomento, qtd);
            fecharModal();
        }

        // L√≥gica de Adi√ß√£o
        function adicionarManual() {
            const busca = document.getElementById('inputProduto').value;
            const qtd = parseInt(document.getElementById('inputQtdRapido').value) || 1;
            const produto = produtosDoBanco.find(p => p.nome.toLowerCase() === busca.toLowerCase());

            if (produto) {
                adicionarAoCarrinho(produto, qtd);
                document.getElementById('inputProduto').value = '';
                document.getElementById('inputQtdRapido').value = 1;
                document.getElementById('inputProduto').focus();
            } else {
                alert("Produto n√£o selecionado!");
            }
        }

        function adicionarAoCarrinho(produto, qtd) {
            const precoFinal = calcularPrecoPromocional(produto.nome, qtd, produto.preco);
            const subtotal = precoFinal * qtd;

            if(precoFinal < produto.preco) {
                mostrarAvisoPromo(`${produto.nome} com pre√ßo especial: R$ ${precoFinal.toFixed(2)}`);
            }

            carrinho.push({
                ...produto,
                nomeDisplay: produto.nome + (precoFinal < produto.preco ? " ‚≠ê" : ""),
                precoUnitario: precoFinal,
                quantidade: qtd,
                subtotal: subtotal
            });

            atualizarInterface();
        }

        function calcularPrecoPromocional(nome, qtd, precoOriginal) {
            const n = nome.toLowerCase();
            if (n.includes("heineken")) return 7.99;
            const marcasPromo = ["antarctica", "brahma", "imperio"];
            if (marcasPromo.some(m => n.includes(m)) && qtd >= 2) return 5.00;
            return precoOriginal;
        }

        function atualizarInterface() {
            const corpo = document.getElementById('corpoCarrinho');
            totalVenda = 0;

            corpo.innerHTML = carrinho.map((item, index) => {
                totalVenda += item.subtotal;
                return `
                    <tr>
                        <td>${item.nomeDisplay}</td>
                        <td>${item.quantidade}</td>
                        <td>R$ ${item.precoUnitario.toFixed(2)}</td>
                        <td>R$ ${item.subtotal.toFixed(2)}</td>
                        <td><button onclick="removerItem(${index})" style="background:none; border:none; color:var(--danger); font-size:1.2rem;">üóëÔ∏è</button></td>
                    </tr>
                `;
            }).join('');

            document.getElementById('valorTotal').innerText = `R$ ${totalVenda.toFixed(2)}`;
            if(formaPagamento === 'Dinheiro') calcularTroco();
        }

        function removerItem(index) {
            carrinho.splice(index, 1);
            atualizarInterface();
        }

        // Pagamento
        function setPagamento(metodo, btn) {
            formaPagamento = metodo;
            document.querySelectorAll('.btn-pgto').forEach(b => b.classList.remove('ativo'));
            btn.classList.add('ativo');

            const secao = document.getElementById('secaoTroco');
            secao.style.display = metodo === 'Dinheiro' ? 'block' : 'none';
            if(metodo === 'Dinheiro') document.getElementById('valorRecebido').focus();
        }

        function calcularTroco() {
            const recebido = parseFloat(document.getElementById('valorRecebido').value) || 0;
            const troco = recebido - totalVenda;
            const display = document.getElementById('trocoResultado');
            display.innerText = `R$ ${Math.max(0, troco).toFixed(2)}`;
            display.style.color = troco >= 0 ? "#27ae60" : "#f1c40f";
        }

        function finalizarVenda() {
            if (carrinho.length === 0) return alert("Adicione produtos primeiro!");
            if (!formaPagamento) return alert("Escolha o pagamento!");

            let recebido = 0;
            if (formaPagamento === 'Dinheiro') {
                recebido = parseFloat(document.getElementById('valorRecebido').value) || 0;
                if (recebido < totalVenda) return alert("Valor insuficiente!");
            }

            gerarRecibo(recebido);
            
            // Enviar ao backend
            fetch(`${API_URL}/vendas`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    total: totalVenda,
                    pagamento: formaPagamento,
                    itens: carrinho
                })
            }).catch(e => console.error("Erro ao salvar venda:", e));

            alert("Venda Finalizada com Sucesso!");
            resetarPDV();
        }

        function gerarRecibo(recebido) {
            const troco = recebido > 0 ? recebido - totalVenda : 0;
            let texto = `==== √â A BOA DISTRIBUIDORA ====\n`;
            texto += `Data: ${new Date().toLocaleString()}\n`;
            texto += `----------------------------------\n`;
            texto += `PRODUTO         QTD   SUBTOTAL\n`;
            
            carrinho.forEach(item => {
                const nomeCurto = item.nome.substring(0, 15).padEnd(16, " ");
                texto += `${nomeCurto} ${item.quantidade.toString().padEnd(5)} R$ ${item.subtotal.toFixed(2)}\n`;
            });

            texto += `----------------------------------\n`;
            texto += `TOTAL: R$ ${totalVenda.toFixed(2)}\n`;
            texto += `PAGAMENTO: ${formaPagamento}\n`;
            if(recebido > 0) {
                texto += `RECEBIDO: R$ ${recebido.toFixed(2)}\n`;
                texto += `TROCO:    R$ ${troco.toFixed(2)}\n`;
            }
            texto += `==================================\n`;
            texto += `OBRIGADO PELA PREFER√äNCIA!`;

            document.getElementById('textoRecibo').innerText = texto;
            document.getElementById('areaRecibo').style.display = 'block';
        }

        function copiarRecibo() {
            const texto = document.getElementById('textoRecibo').innerText;
            // Fallback para document.execCommand se navigator.clipboard falhar
            const el = document.createElement('textarea');
            el.value = texto;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            alert("Cupom copiado para o WhatsApp!");
        }

        function resetarPDV() {
            carrinho = [];
            formaPagamento = '';
            totalVenda = 0;
            document.getElementById('valorRecebido').value = '';
            document.querySelectorAll('.btn-pgto').forEach(b => b.classList.remove('ativo'));
            document.getElementById('secaoTroco').style.display = 'none';
            atualizarInterface();
        }

        function mostrarAvisoPromo(mensagem) {
            const alerta = document.createElement('div');
            alerta.className = 'alerta-promo';
            alerta.innerHTML = `üéâ ${mensagem}`;
            document.body.appendChild(alerta);
            setTimeout(() => {
                alerta.style.opacity = '0';
                setTimeout(() => alerta.remove(), 500);
            }, 3000);
        }
    </script>
</body>
</html>